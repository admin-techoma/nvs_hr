{% extends 'component/base.html' %}
{% load static  %}
{% block title %}Month Salary{% endblock title %}
{% block extracss %}
{% endblock extracss %}
{% block maincontent %}
<div class="main-content">
    <div class="card">
        <div class="card-body">
   
        <div class="d-flex justify-content-between flex-wrap mb-1">
            <form method="post" action="{% url 'payroll:generate_salary' %}" class="w-100">
                {% csrf_token %}
                {% for message in messages %}
                        {% if message.tags == 'success' %}
                        <div class="alert alert-success" role="alert">
                            {{ message }}
                        </div>
                {% else %}
                     <label for="exampleInputEmail1" class="form-label mb-0 text-left text-danger">{{ message }}</label>
                {% endif %}
                {% endfor %}
                {% if form.errors %}
                <div class="alert alert-danger" role="alert">
                    {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                    {{ error }}
                    {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}
                <div class="col-12  d-flex justify-content-between align-items-center ">
                    <div class="d-flex">
                        <div class="col-12 col-md-6 d-flex align-items-center px-2">
                            <label class="form-check-label me-2 " for="year">Year</label>
                            <input type="text" id="year" class="form-control form-control-sm" name="year" value="{{ fiscal_year }}"
                                disabled />
                        </div>
                        <div class="col-12 col-md-6 d-flex align-items-center  px-2">
                            <label class="form-check-label  me-2" for="month">Month</label>
                            <input type="text" id="month" class="form-control form-control-sm" name="month" value="{% now 'F' %}"
                                disabled />
                        </div>  
                    </div>
                        <div class="d-flex justify-content-end  mb-1">
                            {% comment %} {% if show_generate_button %} {% endcomment %}
                            <button type="submit" class="btn custom-button btn-sm">Generate Salary</button>
                            {% comment %} {% endif %} {% endcomment %}
                            {% comment %} <button class="btn custom-button btn-sm" type="submit" name="download_button">Generate
                                Salary
                                <i class="bi bi-box-arrow-down"> </i>
                            </button> {% endcomment %}
                        </div>
                  
                </div>  
                <div class="row overflow-hidden mt-1">
                    <div class="table-responsive overflow-auto ">
                        <table class="table-responsive overflow-auto DataTable" id="salaryTable">
                            <thead class="bg-none">
                                <tr class="bg-none">
                                    {% comment %} <th scope="col">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                                            <label class="form-check-label" for="flexCheckDefault">All</label>
                                        </div>
                                    </th> {% endcomment %}
                                    <th class="d-none" scope="col">Payroll Id</th>
                                    <th scope="col">Emp Id</th>
                                    <th scope="col" style="white-space: nowrap;">Emp Name</th>
                                    <th class="d-none" scope="col">DOJ</th>
                                    <th class="d-none" scope="col">Week Off</th>
                                    <th class="d-none" scope="col">Present Days</th>
                                    <th class="d-none" scope="col">Half Days</th>
                                    <th class="d-none" scope="col">Absent Days</th>
                                    <th scope="col">Paid Days</th>
                                    <th class="d-none"  scope="col">total_days_in_month</th>
                                    <th class="d-none" scope="col">Fixed CTC</th>
                                    <th scope="col" style="width:90px !important ; min-width:90px; max-width:90px;">CTC</th>
                                    <th class="d-none" scope="col">Basic</th>
                                    <th class="d-none" scope="col">HRA</th>
                                    <th class="d-none" scope="col">CA</th>
                                    <th class="d-none" scope="col">SA</th>
                                    <th class="d-none" scope="col">Employer PF</th>
                                    <th class="d-none" scope="col">Employer ESIC</th>
                                    <th class="d-none" scope="col">Employee PF</th>
                                    <th class="d-none" scope="col">Employee ESIC</th>
                                    <th class="d-none" scope="col">PT</th>
                                    <th style="width:350px !important ; min-width:'350px'; max-width:'350px'">Gross Pay</th>
                                    <th style="width:50px !important">Incentives</th>
                                    <th style="width:50px !important">Loan / Other</th>
                                    <th style="width:50px !important">Total Deduction</th>
                                    <th style="width:50px !important">Net Salary Pay</th>
                                    <th class="d-none" scope="col">newCTC</th>
                                    <th class="d-none" scope="col">fixed_basic </th>
                                    <th class="d-none" scope="col">fixed_hra </th>
                                    <th class="d-none" scope="col">fixed_ca </th>
                                    <th class="d-none" scope="col">fixed_sa </th>
                                    <th class="d-none" scope="col">fixed_employerpf </th>
                                    <th class="d-none" scope="col">fixed_employeresic </th>
                                    <th class="d-none" scope="col">fixed_employeepf </th>
                                    <th class="d-none" scope="col">fixed_employeeesic </th>
                                    <th class="d-none" scope="col">fixed_professionalTax </th>
                                    <th class="d-none" scope="col">fixed_gross_salary </th>
                                    <th class="d-none" scope="col">fixed_total_deductions </th>
                                    <th class="d-none" scope="col">fixed_netpay </th>
                                    <th class="d-none" scope="col">fixed_newctc </th>
                                    <th scope="col">Remarks</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-none">
                                {% for employee in employee_data %}
                                {% for payroll_data in payroll_data %}
                                {% if employee.emp_id == payroll_data.emp_id.emp_id %}
                                <tr  class="row-select">
                                    {% comment %} <td scope="col">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="">
                                            <label class="form-check-label" for="flexCheckDefault"></label>
                                        </div>
                                    </td> {% endcomment %}
                                    <td class="d-none"><input id="" name="payroll_id" class="form-control form-control-sm "
                                            value="{{ payroll_data.payroll_id }}" /></td>
                                    <td>
                                        {{ employee.emp_id }}
                                        <input type="hidden" name="emp_id" value="{{ employee.emp_id }}">
                                        {% comment %} <div class="d-flex align-items-center" name="emp_id">
                                            {{ employee.emp_id }}</div> {% endcomment %}
                                    </td>
                                    <td style="white-space: nowrap;">{{employee.name}} <input type="hidden" name="name" value="{{ employee.name }}"></td>
                                    <td class="d-none">{{employee.doj|date:'d-m-Y'}}</td>
                                    <td class="d-none" ><input id="" type="number" class="form-control form-control-sm "
                                            value="{{total_saturdays_and_sundays}}" name="monthly_weekoffdays" /></td>
                                    <td class="d-none"><input id="" type="number" class="form-control form-control-sm "
                                            value="{{employee.total_present_days }}" name="monthly_presentdays" /></td>
                                    <td class="d-none"><input id="" type="number" class="form-control form-control-sm "
                                            value="{{employee.total_half_days }}" name="monthly_halfdays" /></td>
                                    <td class="d-none"><input id="" type="number" class="form-control form-control-sm "
                                            value="{{employee.total_absent_days }}" name="monthly_absentdays" /></td>                                  
                                            <td style="width:150px !important"> <input
                                            id="paid_days" type=""
                                            class="form-control form-control-sm w-100 border-0"
                                            value="{{ employee.total_paid_days }}" name="monthly_paiddays" /></td>
                                            <td class="d-none" style="width:150px !important"> <input
                                                id="total_days" type=""
                                                class="form-control form-control-sm w-100 border-0"
                                                value="{{total_days_in_month}}" name="total_days_in_month" /></td>
                                    <td class="d-none"><input class="form-control form-control-sm "
                                            id="fixedctc" name="fixed_ctc" placeholder="0"
                                            value="{{payroll_data.ctc}}"></td>
                                    <td style="width:90px !important ; min-width:'90px'; max-width:'90px'"><input
                                            type="text" class="form-control form-control-sm w-100 "
                                            id="ctcInput" name="" placeholder="0"
                                            value="{{payroll_data.ctc}}" disabled></td> 
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm"
                                            id="basicAmount" name="monthly_basic"
                                            placeholder="0" value=""></td>

                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm"
                                            id="hraAmount" name="monthly_hra"
                                            placeholder="0" value=""></td>
                                            
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm"
                                            id="ca" name="monthly_ca"
                                            placeholder="0" value=""></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm " id="sa"
                                            name="monthly_sa" placeholder="0" value=""></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm "
                                            id="employerPF" placeholder="0"
                                            name="monthly_employerpf" value=""></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm"
                                            id="employerESIC" name="monthly_employeresic"
                                            placeholder="0" value=""></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm"
                                            id="employeePF" value="" placeholder="0"
                                            name="monthly_employeepf" /></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent"
                                            id="employeeESIC" name="monthly_employeeesic" ></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent"
                                            id="professionalTax"
                                            type="text" class="form-control form-control-sm w-100"
                                            name="monthly_professionalTax"></td>
                                    <td style="width:350px !important ; min-width:'350px'; max-width:'350px'"><input
                                            type="text" class="form-control form-control-sm w-100"
                                            id="grossAmount" name="monthly_gross_salary" disabled></td>
                                    <td style="width:230px !important">
                                        <input type="text"
                                            class="form-control form-control-sm border-1  w-100"
                                            id="monthly_incentive" name="monthly_incentive"
                                            placeholder="0"
                                            oninput="handleIncentiveChange('{{ payroll_data.emp_id.emp_id }}')" />
                                    </td>
                                    <td style="width:280px !important">
                                        <input type="text"
                                            class="form-control form-control-sm border-1  w-100"
                                            id="monthly_loan_other" name="monthly_loan"
                                            placeholder="0"
                                            oninput="handleLoanChange('{{ payroll_data.emp_id.emp_id }}')" />
                                    </td>
                                    <td style="width:230px !important"><input type="text"
                                            class="form-control form-control-sm w-100 border-0"
                                            id="totaldeduction"
                                            name="monthly_total_deductions" placeholder="0" value="" disabled/></td>
                                    <td style="width:230px !important"><input type="text"
                                            class="form-control form-control-sm w-100 border-0"
                                            id="netPay" name="monthly_netpay"
                                            placeholder="0" value="" disabled/></td>
                                    <td class="d-none"><input type="text" class="form-control form-control-sm"
                                            id="newCTC" name="monthly_ctc"
                                            placeholder="0" /></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_basic" placeholder="0" value="{{ payroll_data.basic }}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_hra" placeholder="0" value="{{ payroll_data.hra}}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_ca" placeholder="0" value="{{ payroll_data.ca}}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_sa" placeholder="0" value="{{ payroll_data.sa}}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            placeholder="0" name="fixed_employerpf" value="{{ payroll_data.employer_pf}}">
                                    </td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_employeresic" placeholder="0"
                                            value="{{ payroll_data.employer_esic}}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm border-1 bg-transparent" id=""
                                            value="{{ payroll_data.employee_pf}}" placeholder="0" name="fixed_employeepf" />
                                    </td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_employeeesic" placeholder="0"
                                            value="{{ payroll_data.employee_esic}}"></td>
                                    <td class="d-none"><input type="text"
                                            class="form-control form-control-sm  border-1 bg-transparent" id=""
                                            name="fixed_professionalTax" placeholder="0" value="{{ payroll_data.pt}}"></td>
                                    <td class="d-none"
                                        style="width:350px !important ; min-width:'350px'; max-width:'350px'"><input
                                            type="text" class="form-control form-control-sm w-100 border-0 bg-transparent"
                                            id="" name="fixed_gross_salary" placeholder="0"
                                            value="{{ payroll_data.gross_salary}}"></td>
                                    <td class="d-none" style="width:230px !important"><input type="text"
                                            class=" form-control form-control-sm w-100 border-0" id="" name="fixed_newctc"
                                            placeholder="0" value="{{ payroll_data.monthly_ctc}}" /></td>
                                    <td class="d-none" style="width:230px !important"><input type="text"
                                            class="form-control form-control-sm w-100 border-0" id=""
                                            name="fixed_total_deducation" placeholder="0"
                                            value="{{ payroll_data.total_deduction}}" /></td>
                                    <td class="d-none" style="width:230px !important"><input type="text"
                                            class="form-control form-control-sm w-100 border-0" id="" name="fixed_netpay"
                                            placeholder="0" value="{{ payroll_data.net_salary}}" /></td>
                                    <td style="width:230px !important"><input type="text"
                                            class="form-control form-control-sm border-1 w-100" id=""
                                            name="remarks" placeholder="" value="" /></td>
                                    <td style="width:230px !important">
                                        <div class="d-flex">
                                            <a class="btn btn-sm custom-button me-2 "
                                                href="{% url 'payroll:view_beforegenerate_salary' payroll_data.pk %}"><i
                                                    class="bi bi-eye"></i></a>
                                            {% comment %} <a class="btn btn-sm btn-success me-2"
                                                href="{% url 'payroll:edit_beforegenerate_salary' payroll_data.pk %}"><i
                                                    class="bi bi-pencil-square"></i></a> {% endcomment %}
                                            <!-- Add other actions as needed -->
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4">Totals:</td>
                                    {% comment %} <td id="totalBasic"></td>
                                    <td id="totalHRA"></td>
                                    <td id="totalCA"></td>
                                    <td id="totalSA"></td> {% endcomment %}
                                    <!-- Add more <td> elements for otder columns you want to total -->
                                    <td id="totalGross"></td>
                                    <td></td>
                                    <td></td>
                                    <td id="totalDeduction"></td>
                                    <td id="totalNetPay"></td>
                                    <!-- ... Your existing footer row ... -->
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>    
            </form>
        </div>
    </div>
</div>
    </div>
{%endblock maincontent%}


{% block extrascript %}
<script>
    $(document).ready(function() {
        $('#salaryTable').DataTable({
            responsive: true,
            searching: true,
            paging: true,
            fixedHeader: true,
        });
        document.addEventListener('DOMContentLoaded', function () {
            const activateSwitches = document.querySelectorAll('.activate-switch');
            activateSwitches.forEach(function (switchElement) {
                switchElement.addEventListener('change', function () {
                    const empId = switchElement.dataset.empId;
                    fetch(`/check_payroll_status/${empId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.hasActivePayroll) {
                                switchElement.checked = true;
                            } else {
                                alert('First activate payroll for this employee.');
                                switchElement.checked = false;
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            });
        });
    });

    function calculateNewCtc() {
        var ctc = parseFloat(document.getElementById('fixedctc').value);
        var ctcAmount = document.getElementById('ctcInput');
        var total_days = parseFloat(document.getElementById('total_days').value);
        var paid_days = parseFloat(document.getElementById('paid_days').value);
        var newctc = (ctc * paid_days) / total_days;
        console.log(newctc);
        calculateSalary(newctc);
        ctcAmount.value = newctc;
    }

    function calculateSalary(ctcAmountValue) {
        var basic_perc = 60.0;
        var hra_perc = 30;
        var pf_perc = 12;
        var pf_fix = 1800;
        var employer_esic_perc = 3.25;
        var employee_esic_perc = 0.75;
        var tolerance = 0.01;

        var ctcAmount = document.getElementById('ctcInput');
        var basicAmount = document.getElementById('basicAmount');
        var hraAmount = document.getElementById('hraAmount');
        var ca = document.getElementById('ca');
        var sa = document.getElementById('sa');
        var grossAmount = document.getElementById('grossAmount');
        var employeePF = document.getElementById('employeePF');
        var employerPF = document.getElementById('employerPF');
        var employeeESIC = document.getElementById('employeeESIC');
        var employerESIC = document.getElementById('employerESIC');
        var newCTC = document.getElementById('newCTC');
        var professionalTax = document.getElementById('professionalTax');
        var netPay = document.getElementById('netPay');
        var totaldeduction = document.getElementById('totaldeduction');

        ctcAmountValue = parseFloat(ctcAmountValue) || 0;
        var basicAmountValue = Math.round((basic_perc * ctcAmountValue) / 100);
        var hraAmountValue = Math.round((hra_perc * basicAmountValue) / 100);
        var allowances = ctcAmountValue - (basicAmountValue + hraAmountValue);
        var finalCTC = 0;

        while (Math.abs(finalCTC - ctcAmountValue) > tolerance) {
            var grossAmountValue = basicAmountValue + hraAmountValue + allowances;
            var employerESICValue = grossAmountValue < 21000 ? 0.0325 * grossAmountValue : 0;
            var employerPFValue = (basicAmountValue + allowances > 15000) ? pf_fix : 0.12 * (grossAmountValue - hraAmountValue);
            finalCTC = basicAmountValue + hraAmountValue + allowances + employerPFValue + employerESICValue;

            if (finalCTC < ctcAmountValue) {
                allowances += tolerance;
            } else {
                allowances -= tolerance;
            }
        }

        allowances = Math.round(allowances);
        grossAmountValue = Math.round(basicAmountValue + hraAmountValue + allowances);
        employerPFValue = Math.round((basicAmountValue + allowances > 15000) ? pf_fix : 0.12 * (grossAmountValue - hraAmountValue));
        employerESICValue = Math.round(grossAmountValue < 21000 ? 0.0325 * grossAmountValue : 0);
        finalCTC = Math.round(basicAmountValue + hraAmountValue + allowances + employerPFValue + employerESICValue);
        var employeePFValue = employerPFValue;
        var employeeESICValue = grossAmountValue < 21000 ? Math.round(0.0075 * grossAmountValue) : 0;
        var caValue = allowances * 0.6;
        var saValue = allowances * 0.4;

        basicAmount.value = basicAmountValue.toFixed(2);
        hraAmount.value = hraAmountValue.toFixed(2);
        ca.value = caValue.toFixed(2);
        sa.value = saValue.toFixed(2);
        grossAmount.value = grossAmountValue.toFixed(2);
        employeePF.value = employeePFValue.toFixed(2);
        employerPF.value = employerPFValue.toFixed(2);
        employeeESIC.value = employeeESICValue.toFixed(2);
        employerESIC.value = employerESICValue.toFixed(2);
        newCTC.value = finalCTC.toFixed(2);

        var professionalTaxValue = grossAmountValue > 12000 ? 200 : 0;

        var incentiveAmount = parseFloat(document.getElementById('monthly_incentive').value) || 0;
        // Get the loan input value
        var loanAmount = parseFloat(document.getElementById('monthly_loan_other').value) || 0; 
        var netPayValue = finalCTC - employeeESICValue - employeePFValue - employerESICValue - employerPFValue - professionalTaxValue+ incentiveAmount - loanAmount ;
        var totaldeductionValue = employeeESICValue + employeePFValue + professionalTaxValue + loanAmount;
        professionalTax.value = professionalTaxValue.toFixed(2);
        netPay.value = netPayValue.toFixed(2);
        totaldeduction.value = totaldeductionValue.toFixed(2);
    }
    // Call calculateNewCtc initially to handle default input
    {% for payroll_data in payroll_data %}
    calculateNewCtc("{{ payroll_data.emp_id.emp_id }}");
    {% endfor %}
           // Handle incentive input change
                $('#monthly_incentive').on('input', function () {
                    calculateNewCtc();
                });

                // Handle loan input change
                $('#monthly_loan_other').on('input', function () {
                    calculateNewCtc();
                });
</script>
{% endblock extrascript %}